image: "ruby:2.6.5"

before_script:
  - apt-get update -qq && apt-get install -y -qq postgresql postgresql-contrib libpq-dev cmake
  - ruby -v
  - which ruby

cache:
  paths:
    - vendor/bundle

services:
  - postgres:latest

variables:
  BUNDLE_PATH: vendor/bundle
  DISABLE_SPRING: 1
  RAILS_ENV: test
  SECRET_KEY_BASE: 7d168489ca5e6c2543e94bd8f1477754d26ca6e4d93a646d06e502a68583c86a291a4718b127e2a8b3c3eaddb9ff0aa05f965693cc3c104c69cbf69ed74da5ed
  POSTGRES_DB: test_db
  POSTGRES_USER: runner
  POSTGRES_PASSWORD: ""

stages:
  - lint
  - test

rubocop:
  stage: lint
  script:
  - gem install rubocop -v 0.86
  - rubocop

specs:
  stage: test
  script:
    - gem install bundler
    - bundle check || bundle install
    - cp config/database.yml.ci config/database.yml
    - RAILS_ENV=test bundle exec rake db:create
    - RAILS_ENV=test bundle exec rake db:schema:load
    - RAILS_ENV=test bundle exec rspec

